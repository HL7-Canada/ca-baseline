{
  "resourceType": "StructureDefinition",
  "id": "profile-allergyintolerance",
  "url": "http://hl7.org/fhir/ca/baseline/StructureDefinition/profile-allergyintolerance",
  "version": "1.0.0",
  "name": "AllergyIntoleranceProfile",
  "title": "AllergyIntolerance Profile",
  "status": "draft",
  "date": "2020-09-08",
  "publisher": "HL7 Canada",
  "description": "Proposed constraints and extensions on the AllergyIntolerance Resource",
  "jurisdiction": [
    {
      "coding": [
        {
          "system": "urn:iso:std:iso:3166",
          "code": "CA",
          "display": "Canada"
        }
      ]
    }
  ],
  "fhirVersion": "4.0.1",
  "kind": "resource",
  "abstract": false,
  "type": "AllergyIntolerance",
  "baseDefinition": "http://hl7.org/fhir/StructureDefinition/AllergyIntolerance",
  "derivation": "constraint",
  "differential": {
    "element": [
      {
        "id": "AllergyIntolerance",
        "path": "AllergyIntolerance",
        "short": "AllergyIntolerance Profile",
        "definition": "The AllergyIntolerance Profile is based upon the core FHIR AllergyIntolerance Resource"
      },
      {
        "id": "AllergyIntolerance.identifier",
        "path": "AllergyIntolerance.identifier"
      },
      {
        "id": "AllergyIntolerance.clinicalStatus",
        "path": "AllergyIntolerance.clinicalStatus",
        "isModifier": true,
        "isModifierReason": "This element is labeled as a modifier because the status contains the codes refuted and entered-in-error that mark the AllergyIntolerance as not currently valid."
      },
      {
        "id": "AllergyIntolerance.verificationStatus",
        "path": "AllergyIntolerance.verificationStatus",
        "isModifier": true,
        "isModifierReason": "This element is labeled as a modifier because the status contains the codes refuted and entered-in-error that mark the AllergyIntolerance as not currently valid."
      },
      {
        "id" : "AllergyIntolerance.verificationStatus.coding",
        "path" : "AllergyIntolerance.verificationStatus.coding",
        "comment" : "Many Canadian systems currently use the [AllergyIntoleranceStatusCode](https://fhir.infoway-inforoute.ca/ValueSet/allergyintolerancestatuscode) value set comprised of SNOMED CT codes that can be mapped and provided as additional codings to the required FHIR allergyIntolerance-verification codes.The element is sliced to express the required population of at least one allergyIntolerance-verification coding",
        "slicing" : {
          "discriminator" : [
            {
              "type" : "pattern",
              "path" : "$this"
            }
          ],
          "description" : "Discriminated by the bound value set",
          "rules" : "open"
        },
        "min" : 0,
        "type" : [
          {
            "code" : "Coding"
          }
        ]
      },
      {
        "id": "AllergyIntolerance.verificationStatus.coding:StatusCode",
        "path": "AllergyIntolerance.verificationStatus.coding",
        "sliceName": "StatusCode",
        "short": "Code for allergy or intolerance status",
        "definition": "Code for an allergy or intolerance statement. Represents whether an allergy/intolerance is active or resolved (indicating no longer active).",
        "comment": "The binding strength of this element is [Preferred](https://www.hl7.org/fhir/terminologies.html#strength), meaning that codes are encouraged to draw from the AllergyIntoleranceStatusCode value set for interoperability purposes but are not required to do so to be considered conformant.",
        "min": 0,
        "max": "1",
        "type": [
          {
            "code": "Coding"
          }
        ],
        "binding": {
          "strength": "preferred",
          "description": "Assertion about certainty associated with a propensity, or potential risk, of a reaction to the identified substance.",
          "valueSet": "https://fhir.infoway-inforoute.ca/ValueSet/allergyintolerancestatuscode"
        }
      },
      {
        "id": "AllergyIntolerance.verificationStatus.coding:StatusCode.system",
        "path": "AllergyIntolerance.verificationStatus.coding.system",
        "min": 1
      },
      {
        "id": "AllergyIntolerance.verificationStatus.coding:StatusCode.code",
        "path": "AllergyIntolerance.verificationStatus.coding.code",
        "min": 1
      },
      {
          "id": "AllergyIntolerance.verificationStatus.coding:HL7VerificationStatus",
          "path": "AllergyIntolerance.verificationStatus.coding",
          "sliceName": "HL7VerificationStatus",
          "short": "Required value set for AllergyIntolerance Verification Status.",
          "definition": "Code for an allergy or intolerance statement. Represents whether an allergy/intolerance is active or resolved (indicating no longer active).",
          "min": 1,
          "max": "1",
          "type":  [
              {
                  "code": "Coding"
              }
          ],
          "binding": {
              "strength": "required",
              "description": "Preferred value set for AllergyIntolerance Verification Status.",
              "valueSet": "http://hl7.org/fhir/ValueSet/allergyintolerance-verification|4.0.1"
          }
      },
      {
        "id": "AllergyIntolerance.verificationStatus.coding:HL7VerificationStatus.system",
        "path": "AllergyIntolerance.verificationStatus.coding.system",
        "min": 1,
        "fixedUri": "http://terminology.hl7.org/CodeSystem/allergyintolerance-verification"
      },
      {
        "id": "AllergyIntolerance.verificationStatus.coding:HL7VerificationStatus.code",
        "path": "AllergyIntolerance.verificationStatus.coding.code",
        "min": 1
      },
      {
        "id": "AllergyIntolerance.category",
        "path": "AllergyIntolerance.category",
        "comment" : "Some implementers may utilize value sets where category is readily distinguishable while others may not, and those that do not use those value sets should consider making category MS in their profiles"
      },
      {
        "id": "AllergyIntolerance.code",
        "path": "AllergyIntolerance.code",
        "min": 0,
        "constraint": [
          {
            "key": "ca-baseline-allergy",
            "severity": "error",
            "human": "AllergyIntolerance.verificationStatus SHALL be present if AllergyIntolerance.code represents NullFlavor concept",
            "expression": "AllergyIntolerance.code.coding.where(system = 'https://fhir.infoway-inforoute.ca/ValueSet/NullFlavor').exists() or AllergyIntolerance.verificationStatus.exists()",
            "xpath": "f:code/f:coding/f:system/@value='https://fhir.infoway-inforoute.ca/ValueSet/NullFlavor' or exists(f:verificationStatus)"
          }
        ],
        "mustSupport": true
      },
      {
        "id": "AllergyIntolerance.code.coding",
        "path": "AllergyIntolerance.code.coding",
        "slicing": {
          "discriminator": [
            {
              "type": "value",
              "path": "system"
            }
          ],
          "rules": "closed"
        },
        "min": 0
      },
      {
        "id": "AllergyIntolerance.code.coding:NotAsked",
        "path": "AllergyIntolerance.code.coding",
        "sliceName": "NotAsked",
        "short": "Code for NOT asked or NOT possible to obtain information about allergy or intolerance",
        "definition": "Code for the case when a patient has NOT been asked or it is NOT possible to obtain information about any history of allergy or intolerance.",
        "comment": "The binding strength of this element is [Preferred](https://www.hl7.org/fhir/terminologies.html#strength), meaning that codes are encouraged to draw from the NullFlavor value set for interoperability purposes but are not required to do so to be considered conformant.",
        "min": 0,
        "max": "1",
        "type": [
          {
            "code": "Coding"
          }
        ],
        "constraint": [
          {
            "key": "ca-baseline-allergy-notasked",
            "severity": "error",
            "human": "if AllergyIntolerance.code is a NullFlavor value, then AllergyIntolerance.clinicalStatus, AllergyIntolerance.verificationStatus, AllergyIntolerance.type, AllergyIntolerance.category, AllergyIntolerance.criticality SHALL NOT be present",
            "expression": "AllergyIntolerance.code.coding.where(system = 'https://fhir.infoway-inforoute.ca/ValueSet/NullFlavor').exists() implies (AllergyIntolerance.verificationStatus.exists().not() and AllergyIntolerance.type.exists().not() and AllergyIntolerance.category.exists().not() and AllergyIntolerance.criticality.exists().not())",
            "xpath": "f:code/f:coding/f:system/@value='https://fhir.infoway-inforoute.ca/ValueSet/NullFlavor' and exists(f:verificationStatus).not() and exists(f:type).not() and exists(f:category).not() and exists(f:criticality).not()"
          }
        ],
        "binding": {
          "strength": "preferred",
          "description": "Negation/exclusion codes for reporting no known allergies or not available data.",
          "valueSet": "https://fhir.infoway-inforoute.ca/ValueSet/NullFlavor"
        }
      },
      {
        "id": "AllergyIntolerance.code.coding:NotAsked.system",
        "path": "AllergyIntolerance.code.coding.system",
        "min": 1,
        "fixedUri": "http://terminology.hl7.org/fhir/v3/NullFlavor"
      },
      {
        "id": "AllergyIntolerance.code.coding:NotAsked.code",
        "path": "AllergyIntolerance.code.coding.code",
        "min": 1
      },
      {
        "id": "AllergyIntolerance.code.coding:NoAllergy",
        "path": "AllergyIntolerance.code.coding",
        "sliceName": "NoAllergy",
        "short": "Code when a patient has been asked and has indicated no history of allergies or intolerance",
        "definition": "Code for the case when a patient has been asked and has indicated no history of allergies or intolerance.",
        "min": 0,
        "max": "1",
        "type": [
          {
            "code": "Coding"
          }
        ],
        "constraint": [
          {
            "key": "ca-baseline-allergy-noallergy",
            "severity": "error",
            "human": "if AllergyIntolerance.code is '716186003' No known allergy, then AllergyIntolerance.verificationStatus SHALL be one of the following: confirmed | refuted | entered-in-error",
            "expression": "AllergyIntolerance.code.coding.where(system = 'http://snomed.info/sct' and code = '716186003').exists() and AllergyIntolerance.verificationStatus.coding.where(code = 'unconfirmed').empty()",
            "xpath": "f:code/f:coding/f:system/@value='http://snomed.info/sct' and exists(f:verificationStatus/f:coding/f:code/@value='unconfirmed').not()"
          }
        ]
      },
      {
        "id": "AllergyIntolerance.code.coding:NoAllergy.system",
        "path": "AllergyIntolerance.code.coding.system",
        "min": 1,
        "fixedUri": "http://snomed.info/sct"
      },
      {
        "id": "AllergyIntolerance.code.coding:NoAllergy.code",
        "path": "AllergyIntolerance.code.coding.code",
        "min": 1,
        "fixedCode": "716186003"
      },
      {
        "id": "AllergyIntolerance.code.coding:@default",
        "path": "AllergyIntolerance.code.coding",
        "sliceName": "@default",
        "definition": "Code for an allergy or intolerance statement. This may be a code for a substance or pharmaceutical product that is considered to be responsible for the adverse reaction risk, an allergy or intolerance condition.",
        "comment": "The binding strength of this element is [Example](https://hl7.org/fhir/R4/terminologies.html#example), meaning that codes are not expected or even encouraged to draw from the specified value set to be conformant",
        "min": 0,
        "max": "1",
        "type": [
          {
            "code": "Coding"
          }
        ],
        "binding": {
          "extension": [
            {
              "url": "http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName",
              "valueString": "AllergyIntoleranceCode"
            }
          ],
          "strength": "example",
          "description": "Type of the substance/product, allergy or intolerance condition.",
          "valueSet": "http://hl7.org/fhir/ValueSet/allergyintolerance-code"
        }
      },
      {
        "id": "AllergyIntolerance.patient",
        "path": "AllergyIntolerance.patient",
        "type": [
          {
            "code": "Reference",
            "targetProfile": [
              "http://hl7.org/fhir/ca/baseline/StructureDefinition/profile-patient"
            ]
          }
        ],
        "mustSupport": true
      },
      {
        "id": "AllergyIntolerance.encounter",
        "path": "AllergyIntolerance.encounter",
        "short": "Encounter when the allergy or intolerance was asserted",
        "definition": "The encounter when the allergy or intolerance was asserted.",
        "min": 0,
        "max": "1",
        "type": [
          {
            "code": "Reference",
            "targetProfile": [
              "http://hl7.org/fhir/ca/baseline/StructureDefinition/profile-encounter"
            ]
          }
        ]
      },
      {
        "id": "AllergyIntolerance.onsetDateTime:onsetDateTime",
        "path": "AllergyIntolerance.onsetDateTime",
        "sliceName": "onsetDateTime",
        "comment": "This slice was initially flagged as Must Support, and is considered MS in a handful of Canadian FHIR Implementation Guides. However, while clinically desireable it is not broadly considered MS across all IGuides reviewed during the Due Dilligence Review.",
        "min": 0,
        "type": [
          {
            "code": "dateTime"
          }
        ]
      },
      {
        "id": "AllergyIntolerance.recorder",
        "path": "AllergyIntolerance.recorder",
        "short": "Who recorded the sensitivity",
        "definition": "Individual who recorded the record and takes responsibility for its content.",
        "type": [
          {
            "code": "Reference",
            "targetProfile": [
              "http://hl7.org/fhir/ca/baseline/StructureDefinition/profile-practitioner", "http://hl7.org/fhir/ca/baseline/StructureDefinition/profile-practitionerrole", "http://hl7.org/fhir/ca/baseline/StructureDefinition/profile-patient"
            ]
          }
        ]
      },
      {
        "id": "AllergyIntolerance.asserter",
        "path": "AllergyIntolerance.asserter",
        "short": "Source of the information about the allergy",
        "definition": "The source of the information about the allergy that is recorded.",
        "min": 0,
        "max": "1",
        "type": [
          {
            "code": "Reference",
            "targetProfile": [
              "http://hl7.org/fhir/ca/baseline/StructureDefinition/profile-patient", "http://hl7.org/fhir/ca/baseline/StructureDefinition/profile-practitioner", "http://hl7.org/fhir/ca/baseline/StructureDefinition/profile-practitionerrole"
            ]
          }
        ]
      },
      {
        "id": "AllergyIntolerance.reaction.substance",
        "path": "AllergyIntolerance.reaction.substance",
        "short": "Specific substance or pharmaceutical product considered to be responsible for event"
      },
      {
        "id": "AllergyIntolerance.reaction.substance.coding",
        "path": "AllergyIntolerance.reaction.substance.coding",
        "slicing": {
          "discriminator": [
            {
              "type": "value",
              "path": "system"
            }
          ],
          "rules": "closed"
        },
        "comment": "This slice was initially identified with a 1..* cardinality, and has similar constraints in a handful of Canadian FHIR Implementation Guides. However, while clinically desireable to include coding, it was not constrained consistently across all IGuides reviewed during the Due Dilligence Review."
        },
        {
        "id": "AllergyIntolerance.reaction.substance.coding:NonDrugAllergen",
        "path": "AllergyIntolerance.reaction.substance.coding",
        "sliceName": "NonDrugAllergen",
        "short": "Code for the specific non-drug allergen",
        "definition": "Code for the specific non-drug allergen or other agent/substance to which the Client has an allergic reaction.",
        "comment": "The binding strength of this element is [Preferred](https://www.hl7.org/fhir/terminologies.html#strength), meaning that codes are encouraged to draw from the NonDrugAllergenCode value set for interoperability purposes but are not required to do so to be considered conformant.",
        "type": [
          {
            "code": "Coding"
          }
        ],
        "binding": {
          "strength": "preferred",
          "description": "Represents the specific non-drug allergen or other agent/substance to which the Client has an allergic reaction.",
          "valueSet": "https://fhir.infoway-inforoute.ca/ValueSet/NonDrugAllergenCode"
        }
      },
      {
        "id": "AllergyIntolerance.reaction.substance.coding:NonDrugAllergen.system",
        "path": "AllergyIntolerance.reaction.substance.coding.system",
        "min": 1
      },
      {
        "id": "AllergyIntolerance.reaction.substance.coding:NonDrugAllergen.code",
        "path": "AllergyIntolerance.reaction.substance.coding.code",
        "min": 1
      },
      {
        "id": "AllergyIntolerance.reaction.substance.coding:CCDD",
        "path": "AllergyIntolerance.reaction.substance.coding",
        "sliceName": "CCDD",
        "short": "Medicinal products for prescribing",
        "definition": "The subset of codes with commonly used medicinal products that are available for prescribing and dispensing in Canada.",
        "comment": "The binding strength of this element is [Preferred](https://www.hl7.org/fhir/terminologies.html#strength), meaning that codes are encouraged to draw from the PrescriptionMedicinalProduct value set for interoperability purposes but are not required to do so to be considered conformant.",
        "type": [
          {
            "code": "Coding"
          }
        ],
        "binding": {
          "strength": "preferred",
          "description": "Represents subset of codes with commonly used medicinal products that are available for prescribing and dispensing in Canada.",
          "valueSet": "https://fhir.infoway-inforoute.ca/ValueSet/prescriptionmedicinalproduct"
        }
      },
      {
        "id": "AllergyIntolerance.reaction.substance.coding:CCDD.system",
        "path": "AllergyIntolerance.reaction.substance.coding.system",
        "min": 1,
        "fixedUri": "https://fhir.infoway-inforoute.ca/CodeSystem/canadianclinicaldrugdataset"
      },
      {
        "id": "AllergyIntolerance.reaction.substance.coding:CCDD.code",
        "path": "AllergyIntolerance.reaction.substance.coding.code",
        "min": 1
      },
      {
        "id": "AllergyIntolerance.reaction.substance.coding:@default",
        "path": "AllergyIntolerance.reaction.substance.coding",
        "sliceName": "@default",
        "short": "Specific substance or pharmaceutical product considered to be responsible for event",
        "definition": "Identification of the specific substance (or pharmaceutical product) considered to be responsible for the Adverse Reaction event.",
        "comment": "The binding strength of this element is [Example](https://hl7.org/fhir/R4/terminologies.html#example), meaning that codes are not expected or even encouraged to draw from the specified value set to be conformant",
        "type": [
          {
            "code": "Coding"
          }
        ],
        "binding": {
          "extension": [
            {
              "url": "http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName",
              "valueString": "SubstanceCode"
            }
          ],
          "strength": "example",
          "description": "Codes defining the type of the substance (including pharmaceutical products).",
          "valueSet": "http://hl7.org/fhir/ValueSet/substance-code"
        }
      },
      {
        "id": "AllergyIntolerance.reaction.manifestation",
        "path": "AllergyIntolerance.reaction.manifestation",
        "mustSupport": true
      },
      {
        "id": "AllergyIntolerance.reaction.exposureRoute",
        "path": "AllergyIntolerance.reaction.exposureRoute",
        "short": "How the subject was exposed to the substance",
        "definition": "Identification of the route by which the subject was exposed to the substance.",
        "comment": "The binding strength of this element is [Preferred](https://www.hl7.org/fhir/terminologies.html#strength), meaning that codes are encouraged to draw from the RouteOfAdministration value set for interoperability purposes but are not required to do so to be considered conformant.",
        "type": [
          {
            "code": "CodeableConcept"
          }
        ],
        "binding": {
          "strength": "preferred",
          "description": "A coded concept describing the route or physiological path of administration of a therapeutic agent into or onto the body of a subject.",
          "valueSet": "https://fhir.infoway-inforoute.ca/ValueSet/RouteOfAdministration"
        }
      }
    ]
  }
}
